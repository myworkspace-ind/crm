<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<title>Customer Relationship Management</title>
	<!-- COMMON META AND TITLE -->
	<th:block th:include="fragments/common_meta_title"></th:block>
	
	<!-- HEAD FRAGMENT -->
	<th:block th:include="fragments/head"></th:block>
	<!-- COMMON CSS -->
	<th:block th:include="fragments/common_css"></th:block>
	
	<link rel="stylesheet" type="text/css" href="/library/webjars/bootstrap/5.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" th:href="@{resources/css/new_style.css}">
	<link rel="stylesheet" th:href="@{/resources/css/status.css}" />
	<link rel="stylesheet" th:href="@{/resources/css/buttonGroupFunction.css}" />
	<link rel="stylesheet" th:href="@{/resources/css/buttonRestoreHidedCustomers.css}" />
	<link rel="stylesheet" th:href="@{/resources/css/task.css}" />
	   
	<!-- Intro.js CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js/minified/introjs.min.css" />
	<!-- Intro.js JS -->
	<script src="https://cdn.jsdelivr.net/npm/intro.js/minified/intro.min.js"></script>
	
	<!-- START COMMON JAVASCRIPT -->
	<th:block th:include="fragments/common_javascript"></th:block>
	<!-- END COMMON JAVASCRIPT -->

</head>
<style>
	@keyframes shake {
	    0% { transform: rotate(0); }
	    10% { transform: rotate(15deg); }
	    20% { transform: rotate(-10deg); }
	    30% { transform: rotate(15deg); }
	    40% { transform: rotate(-10deg); }
	    50% { transform: rotate(7deg); }
	    60% { transform: rotate(-7deg); }
	    70% { transform: rotate(5deg); }
	    80% { transform: rotate(-5deg); }
	    90% { transform: rotate(2deg); }
	    100% { transform: rotate(0); }
	}
	
	.shake-icon {
	  display: inline-block;
	  animation: shake 2s infinite;
	  color: #e67e22;
	  margin-left: 6px;
	}
	
	.task-start-soon {
		color: #e67e22; /* cam */
		font-weight: 500;
	}
	
	.task-end-soon {
		color: #3498db; /* xanh dương */
		font-weight: 500;
	}
</style>
<body>
	<!-- BEGIN HEADER  -->
	<th:block th:include="fragments/hmenu"></th:block>
	<!-- END HEADER  -->
	
	<h4 class="mb-4" style = "padding:20px" >Danh sách công việc</h4>

	<div class="task-container" th:each="entry, iterStat : ${taskGroups}">
	    
	    <!-- Header nhóm -->
	    <div class="task-group-header"
		     th:attr="data-toggle-target=${'group-' + iterStat.index}"
		     style="cursor: pointer; font-weight: bold; padding: 10px; border-bottom: 1px solid #ddd; background-color: #f9f9f9;">
		    <span th:text="|${entry.key} (${entry.value.size()})|"></span>
		    <span class="arrow-icon">▼</span>
		</div>
	
	    <!-- Nội dung danh sách task trong nhóm -->
	    <div th:attr="id=${'group-' + iterStat.index}" class="task-group-content" style="display: none; padding: 10px 15px;">
	        <div th:if="${entry.value.isEmpty()}">
	            <em>Không có công việc nào.</em>
	        </div>
	        <div th:each="task : ${entry.value}" class="task-wrapper">
	            <div class="task-item" 
	            	th:data-id="${task.taskId}"
	            	th:data-name="${task.taskName}"
	            	th:data-description="${task.taskDescription}"
     				th:data-start="${task.formattedStartDate}"
     				th:data-due="${task.formattedDueDate}"
     				th:data-remindme="${task.formattedRemindDate}"
	            	th:data-customers="${taskCustomersMap[task.taskId]}"
	            	th:classappend="${task.status} ? 'completed' : ''">
	                <form th:action="@{/task/{taskId}/toggle-complete(taskId=${task.taskId})}" method="post">
	                    <button class="circle-btn" type="submit"></button>
	                </form>
	                
	                <!-- <div class="task-title" th:text="${task.taskName}"></div> -->
	                	
					    <div class="task-title">
						    <span th:text="${task.taskName}"></span>
							
							<!-- Nếu có remind date -->
						    <span th:if="${task.formattedRemindDate != null}"
						          class="remind-me-icon"
						          th:data-remind="${task.formattedRemindDate}"
						          th:data-status="${task.status}">
						        <i class="fa fa-bell-o" style="color: #3246a8"></i><span style="font-size: 12px; color: #3246a8" th:text="${task.formattedRemindDate}">...</span>
						    </span>
						</div>
						<p>
						    <span th:id="'status-msg-' + ${task.taskId}" class="task-status-msg"></span>
						</p>
						
					    
	                <form th:action="@{/task/{taskId}/toggle-important(taskId=${task.taskId})}" method="post">
	                    <button class="star-btn" type="submit">★</button>
	                </form>
	            </div>
	
	            <div class="task-overview">
	                <p><strong>Mô tả công việc:</strong> <span th:text="${task.taskDescription}">...</span></p>
	                <p><strong>Ngày bắt đầu:</strong> <span th:text="${task.formattedStartDate}">...</span></p>
	                <p><strong>Ngày kết thúc</strong> <span th:text="${task.formattedDueDate}">...</span></p>
	                <p><strong>Nhắc nhở vào lúc:</strong> <span th:text="${task.formattedRemindDate}">...</span></p>
	
	                <div th:if="${task.customers != null and !task.customers.isEmpty()}">
	                    <p><strong>Khách hàng liên quan:</strong></p>
	                    <table class="table table-sm">
	                        <thead>
	                            <tr>
		                            <th style="color: #ccc">Tên công ty</th>
		                            <th style="color: #ccc">Người liên hệ</th>
		                            <th style="color: #ccc">SĐT</th>
		                            <th style="color: #ccc">Tương tác liên quan</th>
		                            <th style="color: #ccc">Thời gian tạo</th>
	                            </tr>
	                        </thead>
	                        <tbody>
	                            <tr th:each="cust : ${task.customers}">
	                                <td style="color: #ccc" th:text="${cust.companyName}"></td>
	                                <td style="color: #ccc" th:text="${cust.contactPerson}"></td>
	                                <td style="color: #ccc" th:text="${cust.phone}"></td>
	                                <td style="color: #ccc">
									    <span th:if="${cust.interactionId != null}" th:text="${cust.interactionContent}"></span>
									    <span th:if="${cust.interactionId == null}">Không có</span>
									</td>
									<td style="color: #ccc">
									    <span th:if="${cust.interactionId != null}" th:text="${cust.formattedInteractionCreatedAt}"></span>
									    <span th:if="${cust.interactionId == null}">Không có</span>
									</td>
	                            </tr>
	                        </tbody>
	                    </table>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>
	
	<!-- START TASK DETAIL FOR UPDATING  -->
	<th:block th:include="fragments/frg_taskDetail"></th:block>
	
	<!-- START CUSTOMIZE BUTTON -->
	<th:block th:include="fragments/customizeButton"></th:block>
	<!-- END CUSTOMIZE BUTTON -->

	<!-- PHẦN CHỈNH SỬA KHI HỆ THỐNG ASSETS TRÊN INTERNET BỊ LỖI -->
	<!-- FILE JS BỔ SUNG -->
	<script type="text/javascript" th:src="@{/resources/app-assets/js/update/introTour.js}"></script>
	<script type="text/javascript" th:src="@{/resources/app-assets/js/update/navigate.js}"></script>
	<script type="text/javascript" th:src="@{/resources/app-assets/js/update/search.js}"></script>
	<script type="text/javascript" th:src="@{/resources/app-assets/js/update/buttonGroupFunction.js}"></script>
	<script type="text/javascript" th:src="@{/resources/app-assets/js/update/task.js}"></script>
	
	<script th:inline="javascript">
	    /*<![CDATA[*/
	    let shouldStartTour = /*[[${startTour}]]*/ false;
	    if (shouldStartTour) {
	        window.addEventListener('DOMContentLoaded', function () {
	            startTourCustomer();
	        });
	    }
	    /*]]>*/
	</script>	
	
	<script>
		document.addEventListener("DOMContentLoaded", function () {
		    const icons = document.querySelectorAll(".remind-me-icon");
	
		    icons.forEach(icon => {
		        const remindTimeStr = icon.getAttribute("data-remind");
		        const status = icon.getAttribute("data-status") === "true"; // true = da hoan thanh
	
		        if (!remindTimeStr || status) return;
	
		        // Tach remindTime (fix lỗi định dạng date)
		        const parts = remindTimeStr.split(/[- :]/);
		        const remindTime = new Date(
		            parts[0],                // nam
		            parts[1] - 1,            // thang
		            parts[2],                // ngay
		            parts[3],                // gio
		            parts[4],                // phut
		            parts[5] || 0            // giay
		        );
	
		        const now = new Date();
	
		        if (now >= remindTime) {
		            //icon.classList.add("shake-icon");
		        	icon.querySelector("i").classList.add("shake-icon");
		        }
		    });
		});
	</script>
	
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const taskItems = document.querySelectorAll(".task-item");
	
			taskItems.forEach(item => {
				const startStr = item.getAttribute("data-start");
				const dueStr = item.getAttribute("data-due");
				const statusMessage = document.getElementById("status-msg-" + item.getAttribute("data-id"));
				
				if (!startStr || !dueStr || !statusMessage) return;
	
				const startParts = startStr.split(/[- :]/);
				const dueParts = dueStr.split(/[- :]/);
	
				const startDate = new Date(startParts[0], startParts[1] - 1, startParts[2]);
				const dueDate = new Date(dueParts[0], dueParts[1] - 1, dueParts[2]);
				const today = new Date();
				today.setHours(0, 0, 0, 0); // reset giờ để so sánh chính xác
	
				if (today.getTime() === startDate.getTime()) {
					// Task bắt đầu hôm nay
					const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
					statusMessage.textContent = `Còn ${daysLeft} ngày nữa KẾT THÚC`;
					statusMessage.classList.add("task-end-soon");
				} else if (today < startDate) {
					// Task chưa bắt đầu
					const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
					statusMessage.textContent = `Còn ${daysUntilStart} ngày nữa BẮT ĐẦU`;
					statusMessage.classList.add("task-start-soon");
				}
			});
		});
	</script>
			
</body>
</html>
