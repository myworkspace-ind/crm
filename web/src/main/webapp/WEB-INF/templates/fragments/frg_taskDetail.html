<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link
	href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<style>
  .reminder-dropdown {
    display: none;
    position: absolute;
    background-color: #1f1f1f;
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    width: 240px;
    z-index: 999;
    margin-top: 5px;
    padding: 8px 0;
  }

  .reminder-option {
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }

  .reminder-option:hover {
    background-color: #333;
  }

  .reminder-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .reminder-divider {
    border-top: 1px solid #444;
    margin: 8px 0;
  }

  .reminder-wrapper {
    position: relative;
  }
</style>
<body>
	<!-- Task Detail Sidebar -->
	<div id="taskDetailSidebar" class="task-sidebar" style="display: none;">
		<button class="close-btn" onclick="closeTaskSidebar()">‚úñ</button>

		<form id="taskDetailForm" method="post">
			<input type="hidden" name="taskId" id="sidebarTaskId" />

			<div class="mb-3">
				<label class="form-label"><i class="fa fa-tag"></i> T√™n c√¥ng vi·ªác</label> <input type="text"
					class="form-control" id="sidebarTaskName" name="taskName" />
			</div>

			<div class="mb-3">
				<label class="form-label"><i class="fa fa-list-alt"></i> M√¥ t·∫£</label>
				<textarea class="form-control" id="sidebarTaskDescription"
					name="taskDescription" style="height: auto;"></textarea>
			</div>

			<div class="mb-3">
				<label class="form-label"><i class="fa fa-calendar"></i> Ng√†y b·∫Øt ƒë·∫ßu</label> <input
					type="datetime-local" class="form-control" id="sidebarStartDate"
					name="taskStartDate" />
			</div>
			
			<div class="mb-3">
				<label class="form-label"><i class="fa fa-calendar"></i> Ng√†y k·∫øt th√∫c</label> <input
					type="datetime-local" class="form-control" id="sidebarDueDate"
					name="taskEndDate" />
			</div>
			
			<div class="mb-3 reminder-wrapper">
				<label class="form-label">Nh·∫Øc nh·ªü t√¥i</label>
				<button type="button" class="btn btn-secondary btn-sm" onclick="toggleReminderDropdown()">üîî Ch·ªçn th·ªùi gian nh·∫Øc nh·ªü</button>
				
				<div class="reminder-dropdown" id="reminderDropdown">
					<div class="reminder-option" onclick="selectReminderOption('laterToday')">‚è∞ Later today</div>
					<div class="reminder-option" onclick="selectReminderOption('tomorrow')">‚û°Ô∏è Tomorrow <span id="tomorrow-time">Sat, 9:00 AM</span></div>
					<div class="reminder-option" onclick="selectReminderOption('nextWeek')">‚è≠Ô∏è Next week <span id="next-week-time">Sun, 9:00 AM</span></div>
					<div class="reminder-divider"></div>
					<div class="reminder-option" onclick="selectReminderOption('custom')">üìÖ Pick a date & time</div>
				</div>
				
				<!-- Input ·∫©n ƒë·ªÉ l∆∞u gi√° tr·ªã nh·∫Øc nh·ªü -->
				<input type="datetime-local" class="form-control mt-2" id="reminderInput" name="reminderDateTime" style="display: none;" />
			</div>

			<div class="mb-3">
				<label class="form-label">Kh√°ch h√†ng li√™n quan</label>
				<div id="sidebarCustomerContainer"></div>
				<button type="button" class="btn btn-link"
					onclick="addSidebarCustomer()">+ Th√™m kh√°ch h√†ng</button>
			</div>

			<button type="submit" class="btn btn-primary">L∆∞u</button>
			<button type="button" class="btn btn-danger" onclick="deleteTask()">üóëÔ∏è
				X√≥a</button>
		</form>
	</div>

	<select class="form-control select2" id="customerOptionsTemplate"
		style="width: 100%; display: none;">
		<option value="" disabled selected>-- Ch·ªçn kh√°ch h√†ng --</option>
		<option th:each="cust : ${listCustomers}" th:value="${cust.id}"
			th:text="${cust.companyName}"
			th:attr="data-contact-person=${cust.contactPerson}"></option>
	</select>
</body>
<script>
    let customerOptionsHtml = "";

    $(document).ready(function () {
        customerOptionsHtml = $('#customerOptionsTemplate option').map(function () {
            const value = $(this).attr('value');
            const contactPerson = $(this).attr('data-contact-person') || '';
            const text = $(this).text();
            return `<option value="${value}" data-contact-person="${contactPerson}">${text}</option>`;
        }).get().join('');
    });
</script>

<script>
	function openTaskSidebar(taskId, taskName, description, startDate, dueDate, remindDate, customers) {
	    document.getElementById('sidebarTaskId').value = taskId;
	    document.getElementById('sidebarTaskName').value = taskName;
	    document.getElementById('sidebarTaskDescription').value = description;
	    document.getElementById('sidebarStartDate').value = startDate;
	    document.getElementById('sidebarDueDate').value = dueDate;
	    
	    const reminderInput = document.getElementById('reminderInput');
	    reminderInput.value = remindDate || '';
	    reminderInput.style.display = remindDate ? 'block' : 'none';
	    
	    const container = document.getElementById('sidebarCustomerContainer');
	    container.innerHTML = "";
	
	    customers.forEach((cust, index) => {
	        const block = document.createElement("div");
	        block.className = "customer-block mb-2";
	
	        block.innerHTML = `
	            <div class="row align-items-center">
	                <div class="col-6">
	                    <select class="form-control select2" name="customers[${index}].customerId">
	                        <option></option>
	                        ${customerOptionsHtml}
	                    </select>
	                </div>
	                <div class="col-5">
	                    <input type="text" class="form-control contact-person-input" name="customers[${index}].contactPerson" placeholder="Ng∆∞·ªùi li√™n h·ªá" value="${cust.contactPerson || ''}" readonly />
	                </div>
	                <div class="col-1 text-end">
	                    <button type="button" class="btn btn-sm btn-outline-danger remove-customer" title="X√≥a kh√°ch h√†ng">
	                        &times;
	                    </button>
	                </div>
	                
	                <div class="col-12 mt-2">
	                    <label class="form-label">T∆∞∆°ng t√°c g·∫ßn ƒë√¢y</label>
	                    <select class="form-control interaction-select2" name="customers[${index}].interactionId" style="width: 100%;">
	                        <option value="">ƒêang t·∫£i...</option>
	                    </select>
 	                    <small class="text-muted created-at-label">${cust.formattedInteractionCreatedAt || ''}</small>
	                </div>
	            </div>
	        `;
	
	        container.appendChild(block);
	
	        const select = block.querySelector(".select2");
	        
	        console.log("cust.id:", cust.customerId);
	        console.log("customerOptionsHtml:", customerOptionsHtml);
	
	        // Kh·ªüi t·∫°o select2
	        $(select).select2({
	            placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
	            width: "100%",
	            allowClear: true,
	            language: "vi"
	        });
	        
	     // G√°n gi√° tr·ªã customerId (c·∫ßn t·ªìn t·∫°i trong `cust.id`)
	       	if (cust.customerId) {
			    $(select).val(String(cust.customerId)).trigger("change");
			}
	
	        // Khi ch·ªçn c√¥ng ty ‚Üí ƒëi·ªÅn ng∆∞·ªùi li√™n h·ªá
	        $(select).on("change", function () {
	            const contact = $(this).find(':selected').data('contact-person') || "";
	            $(this).closest('.row').find('.contact-person-input').val(contact);
	        });
	
	        // N·∫øu ƒë√£ c√≥ gi√° tr·ªã ‚Üí trigger change ƒë·ªÉ hi·ªán contactPerson ƒë√∫ng
	        $(select).trigger("change");
	
	        // N√∫t x√≥a
	        block.querySelector(".remove-customer").addEventListener("click", function () {
	            block.remove();
	        });
	    });
	
	    document.getElementById('taskDetailSidebar').style.display = 'block';
	}

	function closeTaskSidebar() {
	    document.getElementById('taskDetailSidebar').style.display = 'none';
	}

	function addSidebarCustomer() {
	    const container = document.getElementById('sidebarCustomerContainer');
	    const index = container.children.length;

	    const block = document.createElement("div");
	    block.className = "customer-block mb-2";
	    block.innerHTML = `
	        <div class="row align-items-center">
	            <div class="col-6">
	                <select class="form-control select2" name="customers[${index}].customerId">
	                    <option></option>
	                    ${customerOptionsHtml}
	                </select>
	            </div>
	            <div class="col-5">
	                <input type="text" class="form-control contact-person-input" name="customers[${index}].contactPerson" placeholder="Ng∆∞·ªùi li√™n h·ªá" readonly />
	            </div>
	            <div class="col-1 text-end">
	                <button type="button" class="btn btn-sm btn-outline-danger remove-customer" title="X√≥a kh√°ch h√†ng">
	                    &times;
	                </button>
	            </div>
	            
	            <div class="col-12 mt-2">
		            <label class="form-label">T∆∞∆°ng t√°c g·∫ßn ƒë√¢y</label>
		            <select class="form-control interaction-select2" name="customers[${index}].interactionId" style="width: 100%;">
		                <option value="">ƒêang t·∫£i...</option>
		            </select>
		            <small class="text-muted created-at-label"></small>
		        </div>
	        </div>
	    `;

	    container.appendChild(block);

	    // Kh·ªüi t·∫°o select2
	    const select = block.querySelector(".select2");
	    const interactionSelect = block.querySelector(".interaction-select2");
	    const contactInput = block.querySelector(".contact-person-input");
	    const createdAtLabel = block.querySelector(".created-at-label");
	    
// 	 // Th√™m option t∆∞∆°ng ·ª©ng v·ªõi kh√°ch h√†ng ƒëang c√≥ trong task
// 	    const option = document.createElement("option");
// 	    option.value = cust.id;
// 	    option.text = cust.companyName;
// 	    option.selected = true;
// 	    option.dataset.contactPerson = cust.contactPerson || "";
// 	    select.appendChild(option);
	    
	    $(select).select2({
	        placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
	        width: "100%",
	        allowClear: true,
	        language: "vi"
	    });

	    // Khi ch·ªçn c√¥ng ty
	    $(select).on("change", function () {
	        const selectedOption = $(this).find(':selected');
	        const contact = selectedOption.data('contact-person') || "";
	        const customerId = $(this).val();

	        contactInput.value = contact;

	        // Load danh s√°ch t∆∞∆°ng t√°c
	        $(interactionSelect).empty().append('<option value="">ƒêang t·∫£i...</option>');

	        if (customerId) {
	            $.ajax({
	                url: _ctx + 'task/interactions/' + customerId,
	                method: 'GET',
	                success: function (data) {
	                    $(interactionSelect).empty().append('<option value="">Ch·ªçn t∆∞∆°ng t√°c...</option>');
	                    data.forEach(interaction => {
	                        $(interactionSelect).append(
	                            $('<option>', {
	                                value: interaction.id,
	                                text: interaction.content,
	                                'data-created-at': interaction.createdAt
	                            })
	                        );
	                    });
	                },
	                error: function () {
	                    $(interactionSelect).empty().append('<option>L·ªói khi t·∫£i t∆∞∆°ng t√°c</option>');
	                }
	            });
	        }
	    });

	    // Khi ch·ªçn t∆∞∆°ng t√°c ‚Üí hi·ªán ng√†y t·∫°o
	    $(interactionSelect).on("change", function () {
	        const createdAt = $(this).find('option:selected').data('created-at') || '';
	        createdAtLabel.textContent = createdAt ? `Ng√†y t·∫°o: ${createdAt}` : '';
	    });

	    // X√≥a
	    block.querySelector(".remove-customer").addEventListener("click", function () {
	        block.remove();
	    });
	}

	function deleteTask() {
	    const taskId = document.getElementById('sidebarTaskId').value;

	    if (!taskId) {
	        Swal.fire("Kh√¥ng c√≥ ID c√¥ng vi·ªác ƒë·ªÉ x√≥a!", "", "warning");
	        return;
	    }

	    Swal.fire({
	        title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?',
	        text: "Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
	        icon: 'warning',
	        showCancelButton: true,
	        confirmButtonColor: '#d33',
	        cancelButtonColor: '#6c757d',
	        confirmButtonText: 'X√≥a',
	        cancelButtonText: 'H·ªßy'
	    }).then((result) => {
	        if (result.isConfirmed) {
	            $.ajax({
	                url: _ctx + `task/${taskId}/delete`,
	                type: 'DELETE',
	                success: function() {
	                    Swal.fire("ƒê√£ x√≥a!", "C√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c x√≥a.", "success")
	                        .then(() => {
	                            closeTaskSidebar();
	                            location.reload(); // ho·∫∑c g·ªçi l·∫°i h√†m load danh s√°ch n·∫øu c√≥
	                        });
	                },
	                error: function(xhr, status, error) {
	                    console.error(error);
	                    Swal.fire("L·ªói!", "X·∫£y ra l·ªói khi x√≥a.", "error");
	                }
	            });
	        }
	    });
	}

	document.addEventListener("keydown", function(e) {
	    if (e.key === "Escape") {
	        closeTaskSidebar();
	    }
	});
	
	$('#taskDetailForm').on('submit', function (e) {
	    e.preventDefault();

	    const id = $('#sidebarTaskId').val();
	    const name = $('#sidebarTaskName').val();
	    const description = $('#sidebarTaskDescription').val();
	    const startDate = $('#sidebarStartDate').val();
	    const dueDate = $('#sidebarDueDate').val();
	    const remindDate = $('#reminderInput').val();

	    const customerIds = [];
	    $('#sidebarCustomerContainer .customer-block').each(function () {
	        const customerId = $(this).find('.select2').val(); // n·∫øu d√πng select2
	        if (customerId) {
	            customerIds.push(Number(customerId));
	        }
	    });

	    const data = {
	        id,
	        name,
	        description,
	        startDate,
	        dueDate,
	        remindDate,
	        customerIds
	    };
	    
	    console.log("D·ªØ li·ªáu g·ª≠i l√™n:", data);

	    $.ajax({
	        url: _ctx + 'task/update-task',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify(data),
	        success: function () {
	            Swal.fire("Th√†nh c√¥ng", "C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng", "success")
	                .then(() => {
	                    closeTaskSidebar();
	                    location.reload();
	                });
	        },
	        error: function () {
	            Swal.fire("L·ªói", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¥ng vi·ªác", "error");
	        }
	    });
	});

</script>

<script>
  function toggleReminderDropdown() {
    const dropdown = document.getElementById('reminderDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';

    const now = new Date();

    // T√≠nh th·ªùi gian "Tomorrow"
    const tomorrow = new Date(now);
    tomorrow.setDate(now.getDate() + 1);
    tomorrow.setHours(9, 0, 0, 0);

    // T√≠nh th·ªùi gian "Next week"
    const nextWeek = new Date(now);
    nextWeek.setDate(now.getDate() + (7 - now.getDay()) % 7 + 1); // Ch·ªß nh·∫≠t t·ªõi
    nextWeek.setHours(9, 0, 0, 0);

    // C·∫≠p nh·∫≠t text
    document.getElementById('tomorrow-time').innerText = formatDate(tomorrow);
    document.getElementById('next-week-time').innerText = formatDate(nextWeek);

    // X·ª≠ l√Ω "Later today"
    const laterTodayOption = document.querySelector('.reminder-option[onclick*="laterToday"]');
    if (now.getHours() >= 18) {
      laterTodayOption.classList.add('disabled');
      laterTodayOption.onclick = null;
    } else {
      laterTodayOption.classList.remove('disabled');
      laterTodayOption.setAttribute('onclick', "selectReminderOption('laterToday')");
    }
  }

  function formatDate(date) {
    return date.toLocaleDateString('en-US', {
      weekday: 'short',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  }

  function selectReminderOption(option) {
	  const input = document.getElementById('reminderInput');
	  input.style.display = 'block';
	  let selectedDate = new Date();
	
	if (option === 'tomorrow') {
		selectedDate.setDate(selectedDate.getDate() + 1);
		selectedDate.setHours(9, 0, 0, 0);
	} else if (option === 'nextWeek') {
		selectedDate.setDate(selectedDate.getDate() + (7 - selectedDate.getDay()) % 7 + 1);
		selectedDate.setHours(9, 0, 0, 0);
    } else if (option === 'laterToday') {
    	selectedDate.setHours(17, 0, 0, 0); // Nhac luc 5h chieu
    } else if (option === 'custom') {
    	input.value = '';
    	input.focus();
    	document.getElementById('reminderDropdown').style.display = 'none';
    	return;
    }

	input.value = selectedDate.toISOString().slice(0, 16); // format for datetime-local
	document.getElementById('reminderDropdown').style.display = 'none';
  }

  // ƒê√≥ng dropdown n·∫øu click b√™n ngo√†i
  document.addEventListener('click', function (e) {
    const dropdown = document.getElementById('reminderDropdown');
    const button = e.target.closest('button');
    if (!dropdown.contains(e.target) && (!button || button.getAttribute('onclick') !== 'toggleReminderDropdown()')) {
      dropdown.style.display = 'none';
    }
  });
</script>


</html>