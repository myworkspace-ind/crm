<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link
	href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
	rel="stylesheet" />
<script
	src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>
<body>
	<!-- Task Detail Sidebar -->
	<div id="taskDetailSidebar" class="task-sidebar" style="display: none;">
		<button class="close-btn" onclick="closeTaskSidebar()">‚úñ</button>

		<form id="taskDetailForm" method="post">
			<input type="hidden" name="taskId" id="sidebarTaskId" />

			<div class="mb-3">
				<label class="form-label">T√™n c√¥ng vi·ªác</label> <input type="text"
					class="form-control" id="sidebarTaskName" name="taskName" />
			</div>

			<div class="mb-3">
				<label class="form-label">M√¥ t·∫£</label>
				<textarea class="form-control" id="sidebarTaskDescription"
					name="taskDescription"></textarea>
			</div>

			<div class="mb-3">
				<label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label> <input
					type="datetime-local" class="form-control" id="sidebarStartDate"
					name="taskStartDate" />
			</div>

			<div class="mb-3">
				<label class="form-label">Kh√°ch h√†ng li√™n quan</label>
				<div id="sidebarCustomerContainer"></div>
				<button type="button" class="btn btn-link"
					onclick="addSidebarCustomer()">+ Th√™m kh√°ch h√†ng</button>
			</div>

			<button type="submit" class="btn btn-primary">L∆∞u</button>
			<button type="button" class="btn btn-danger" onclick="deleteTask()">üóëÔ∏è
				X√≥a</button>
		</form>
	</div>

	<select class="form-control select2" id="customerOptionsTemplate"
		style="width: 100%; display: none;">
		<option value="" disabled selected>-- Ch·ªçn kh√°ch h√†ng --</option>
		<option th:each="cust : ${listCustomers}" th:value="${cust.id}"
			th:text="${cust.companyName}"
			th:attr="data-contact-person=${cust.contactPerson}"></option>
	</select>
</body>
<script>
    let customerOptionsHtml = "";

    $(document).ready(function () {
        customerOptionsHtml = $('#customerOptionsTemplate option').map(function () {
            const value = $(this).attr('value');
            const contactPerson = $(this).attr('data-contact-person') || '';
            const text = $(this).text();
            return `<option value="${value}" data-contact-person="${contactPerson}">${text}</option>`;
        }).get().join('');
    });
</script>

<script>
	function openTaskSidebar(taskId, taskName, description, startDate, customers) {
	    document.getElementById('sidebarTaskId').value = taskId;
	    document.getElementById('sidebarTaskName').value = taskName;
	    document.getElementById('sidebarTaskDescription').value = description;
	    document.getElementById('sidebarStartDate').value = startDate;
	
	    const container = document.getElementById('sidebarCustomerContainer');
	    container.innerHTML = "";
	
	    customers.forEach((cust, index) => {
	        const block = document.createElement("div");
	        block.className = "customer-block mb-2";
	
	        block.innerHTML = `
	            <div class="row align-items-center">
	                <div class="col-6">
	                    <select class="form-control select2" name="customers[${index}].customerId">
	                        <option></option>
	                        ${customerOptionsHtml}
	                    </select>
	                </div>
	                <div class="col-5">
	                    <input type="text" class="form-control contact-person-input" name="customers[${index}].contactPerson" placeholder="Ng∆∞·ªùi li√™n h·ªá" value="${cust.contactPerson || ''}" readonly />
	                </div>
	                <div class="col-1 text-end">
	                    <button type="button" class="btn btn-sm btn-outline-danger remove-customer" title="X√≥a kh√°ch h√†ng">
	                        &times;
	                    </button>
	                </div>
	            </div>
	        `;
	
	        container.appendChild(block);
	
	        const select = block.querySelector(".select2");
	        
	        console.log("cust.id:", cust.customerId);
	        console.log("customerOptionsHtml:", customerOptionsHtml);
	
	        // Kh·ªüi t·∫°o select2
	        $(select).select2({
	            placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
	            width: "100%",
	            allowClear: true,
	            language: "vi"
	        });
	        
	     // G√°n gi√° tr·ªã customerId (c·∫ßn t·ªìn t·∫°i trong `cust.id`)
	       	if (cust.customerId) {
			    $(select).val(String(cust.customerId)).trigger("change");
			}
	
	        // Khi ch·ªçn c√¥ng ty ‚Üí ƒëi·ªÅn ng∆∞·ªùi li√™n h·ªá
	        $(select).on("change", function () {
	            const contact = $(this).find(':selected').data('contact-person') || "";
	            $(this).closest('.row').find('.contact-person-input').val(contact);
	        });
	
	        // N·∫øu ƒë√£ c√≥ gi√° tr·ªã ‚Üí trigger change ƒë·ªÉ hi·ªán contactPerson ƒë√∫ng
	        $(select).trigger("change");
	
	        // N√∫t x√≥a
	        block.querySelector(".remove-customer").addEventListener("click", function () {
	            block.remove();
	        });
	    });
	
	    document.getElementById('taskDetailSidebar').style.display = 'block';
	}

	function closeTaskSidebar() {
	    document.getElementById('taskDetailSidebar').style.display = 'none';
	}

	function addSidebarCustomer() {
	    const container = document.getElementById('sidebarCustomerContainer');
	    const index = container.children.length;

	    const block = document.createElement("div");
	    block.className = "customer-block mb-2";
	    block.innerHTML = `
	        <div class="row align-items-center">
	            <div class="col-6">
	                <select class="form-control select2" name="customers[${index}].customerId">
	                    <option></option>
	                    ${customerOptionsHtml}
	                </select>
	            </div>
	            <div class="col-5">
	                <input type="text" class="form-control contact-person-input" name="customers[${index}].contactPerson" placeholder="Ng∆∞·ªùi li√™n h·ªá" readonly />
	            </div>
	            <div class="col-1 text-end">
	                <button type="button" class="btn btn-sm btn-outline-danger remove-customer" title="X√≥a kh√°ch h√†ng">
	                    &times;
	                </button>
	            </div>
	        </div>
	    `;

	    container.appendChild(block);

	    // Kh·ªüi t·∫°o select2
	    const select = block.querySelector(".select2");
	    
	 // Th√™m option t∆∞∆°ng ·ª©ng v·ªõi kh√°ch h√†ng ƒëang c√≥ trong task
	    const option = document.createElement("option");
	    option.value = cust.id;
	    option.text = cust.companyName;
	    option.selected = true;
	    option.dataset.contactPerson = cust.contactPerson || "";
	    select.appendChild(option);
	    
	    $(select).select2({
	        placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
	        width: "100%",
	        allowClear: true,
	        language: "vi"
	    });

	    // Khi ch·ªçn c√¥ng ty th√¨ t·ª± ƒë·ªông ƒëi·ªÅn ng∆∞·ªùi li√™n h·ªá
	    $(select).on("change", function () {
	        const contact = $(this).find(':selected').data('contact-person') || "";
	        $(this).closest('.row').find('.contact-person-input').val(contact);
	    });

	    // X√≥a
	    block.querySelector(".remove-customer").addEventListener("click", function () {
	        block.remove();
	    });
	}

	function deleteTask() {
	    const taskId = document.getElementById('sidebarTaskId').value;

	    if (!taskId) {
	        Swal.fire("Kh√¥ng c√≥ ID c√¥ng vi·ªác ƒë·ªÉ x√≥a!", "", "warning");
	        return;
	    }

	    Swal.fire({
	        title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?',
	        text: "Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
	        icon: 'warning',
	        showCancelButton: true,
	        confirmButtonColor: '#d33',
	        cancelButtonColor: '#6c757d',
	        confirmButtonText: 'X√≥a',
	        cancelButtonText: 'H·ªßy'
	    }).then((result) => {
	        if (result.isConfirmed) {
	            $.ajax({
	                url: _ctx + `task/${taskId}/delete`,
	                type: 'DELETE',
	                success: function() {
	                    Swal.fire("ƒê√£ x√≥a!", "C√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c x√≥a.", "success")
	                        .then(() => {
	                            closeTaskSidebar();
	                            location.reload(); // ho·∫∑c g·ªçi l·∫°i h√†m load danh s√°ch n·∫øu c√≥
	                        });
	                },
	                error: function(xhr, status, error) {
	                    console.error(error);
	                    Swal.fire("L·ªói!", "X·∫£y ra l·ªói khi x√≥a.", "error");
	                }
	            });
	        }
	    });
	}

	document.addEventListener("keydown", function(e) {
	    if (e.key === "Escape") {
	        closeTaskSidebar();
	    }
	});
	
	$('#taskDetailForm').on('submit', function (e) {
	    e.preventDefault();

	    const id = $('#sidebarTaskId').val();
	    const name = $('#sidebarTaskName').val();
	    const description = $('#sidebarTaskDescription').val();
	    const startDate = $('#sidebarStartDate').val();

	    const customerIds = [];
	    $('#sidebarCustomerContainer .customer-block').each(function () {
	        const customerId = $(this).find('.select2').val(); // n·∫øu d√πng select2
	        if (customerId) {
	            customerIds.push(Number(customerId));
	        }
	    });

	    const data = {
	        id,
	        name,
	        description,
	        startDate,
	        customerIds
	    };
	    
	    console.log("D·ªØ li·ªáu g·ª≠i l√™n:", data);

	    $.ajax({
	        url: _ctx + 'task/update-task',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify(data),
	        success: function () {
	            Swal.fire("Th√†nh c√¥ng", "C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng", "success")
	                .then(() => {
	                    closeTaskSidebar();
	                    location.reload();
	                });
	        },
	        error: function () {
	            Swal.fire("L·ªói", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¥ng vi·ªác", "error");
	        }
	    });
	});

</script>

</html>