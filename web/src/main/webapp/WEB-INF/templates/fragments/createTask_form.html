<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
		<!--<form th:action="@{/tasks/create}" method="post"> -->
		<form id="taskForm">
	        <!-- T√™n c√¥ng vi·ªác -->
	        <div class="form-section">
	            <label for="taskName" class="form-label">T√™n c√¥ng vi·ªác</label>
	            <input type="text" class="form-control" id="taskName" name="taskName" required>
	        </div>
	
	        <!-- M√¥ t·∫£ -->
	        <div class="form-section">
	            <label for="taskDescription" class="form-label">M√¥ t·∫£ c√¥ng vi·ªác</label>
	            <textarea class="form-control" id="taskDescription" name="taskDescription" rows="4"></textarea>
	        </div>
	
	        <!-- Ng√†y b·∫Øt ƒë·∫ßu -->
	        <div class="form-section">
	            <label for="startDate" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
	            <input type="datetime-local" class="form-control" id="startDate" name="startDate">
	        </div>
	        
	        <!-- Ng√†y k·∫øt th√∫c -->
	        <div class="form-section">
	            <label for="dueDate" class="form-label">Ng√†y k·∫øt th√∫c</label>
	            <input type="datetime-local" class="form-control" id="dueDate" name="dueDate">
	        </div>
	
	        <!-- Kh√°ch h√†ng li√™n quan -->
	        <div class="form-section">
	            <label class="form-label">Kh√°ch h√†ng li√™n quan</label>
	            <div id="customerContainer">
	            
	                <!-- Block kh√°ch h√†ng m·∫´u -->
	                <div class="customer-block">
					    <div class="row">
					        <div class="col-md-6">
					            <label class="form-label">Kh√°ch h√†ng</label>
					            <select class="form-control select2" name="customers[0].customerId" style="width: 100%;">
					                <option></option>
					                <th:block th:each="customer : ${listCustomers}">
					                    <option th:value="${customer.id}" 
					                            th:attr="data-contact-person=${customer.contactPerson}"
					                            th:text="${customer.companyName}"></option>
					                </th:block>
					            </select>
					        </div>
					        <div class="col-md-6">
					            <label class="form-label">Ng∆∞·ªùi li√™n h·ªá</label>
					            <input type="text" class="form-control contact-person-input" readonly />
					        </div>
					    </div>
					    
					    <div class="col-md-12 mt-2 interaction-group">
						    <label class="form-label">T∆∞∆°ng t√°c g·∫ßn ƒë√¢y</label>
						    <select class="form-control interaction-select2" name="customers[0].interactionId" style="width: 100%;">
						        <option value="">Ch·ªçn t∆∞∆°ng t√°c...</option>
						    </select>
						    <small class="text-muted created-at-label"></small>
						</div>
					    <button type="button" class="btn btn-link text-danger remove-btn" onclick="removeCustomer(this)">üóëÔ∏è</button>
					</div>
	                
	            </div>
	            <button type="button" class="btn btn-outline-primary mt-2" onclick="addCustomer()">+ Th√™m kh√°ch h√†ng</button>
	        </div>
	
	        <!-- Submit -->
	        <div class="form-section">
	            <button type="submit" class="btn btn-success">T·∫°o m·ªõi</button>
	            <a th:href="@{/task/list}" class="btn btn-secondary">H·ªßy</a>
	        </div>
	    </form>
	
	<script>
// 		$(window).on('load', function () {
// 		    $('.select2').select2({
// 		        tags: true,
// 		        placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n",
// 		        language: "vi",
// 		        allowClear: true
// 		    });
	
// 		    $('.select2').on('select2:open', function () {
// 		        $('.select2-search__field').attr('placeholder', 'T√¨m ki·∫øm...');
// 		    });
// 		});
		let customerOptionsHtml = "";

		function initializeCustomerSelect(selectElement) {
		    $(selectElement).select2({
		        placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
		        tags: true,
		        allowClear: true,
		        language: "vi"
		    });
	
		    $(selectElement).on('select2:select', function () {
		        const contactPerson = $(this).find(':selected').attr('data-contact-person') || '';
		        $(this).closest('.customer-block').find('.contact-person-input').val(contactPerson);
		    });
	
		    $(selectElement).on('select2:unselect', function () {
		        $(this).closest('.customer-block').find('.contact-person-input').val('');
		    });
		}
	
		$(document).ready(function () {
		    // L∆∞u l·∫°i option HTML ƒë·ªÉ d√πng l·∫°i sau n√†y
		    customerOptionsHtml = $('#customerContainer .select2:first option').map(function () {
		        const value = $(this).attr('value');
		        const contactPerson = $(this).attr('data-contact-person') || '';
		        const text = $(this).text();
		        return `<option value="${value}" data-contact-person="${contactPerson}">${text}</option>`;
		    }).get().join('');

		    // Kh·ªüi t·∫°o select2 cho block ƒë·∫ßu ti√™n
		    initializeCustomerSelect($('.select2').first());
		});
		
		$(document).on('change',  '.select2', function () {
	        const customerId = $(this).val();
	        const $block = $(this).closest('.customer-block');
	        const $interactionSelect = $block.find('.interaction-select2');
	        const $createdAtLabel = $block.find('.created-at-label');

	        $interactionSelect.empty().append('<option value="">ƒêang t·∫£i...</option>');

	        if (customerId) {
	            $.ajax({
	                url: _ctx + 'task/interactions/' + customerId,
	                method: 'GET',
	                success: function (data) {
	                    $interactionSelect.empty().append('<option value="">Ch·ªçn t∆∞∆°ng t√°c...</option>');
	                    data.forEach(interaction => {
	                        $interactionSelect.append(
	                            $('<option>', {
	                                value: interaction.id,
	                                text: interaction.content,
	                                'data-created-at': interaction.createdAt
	                            })
	                        );
	                    });
	                },
	                error: function () {
	                    $interactionSelect.empty().append('<option>L·ªói khi t·∫£i t∆∞∆°ng t√°c</option>');
	                }
	            });
	        }
	    });

	    $(document).on('change', '.interaction-select2', function () {
	        const $block = $(this).closest('.customer-block');
	        const createdAt = $(this).find('option:selected').data('created-at') || '';
	        $block.find('.created-at-label').text(createdAt ? `Ng√†y t·∫°o: ${createdAt}` : '');
	    });
	    
		function addCustomer() {
		    const container = document.getElementById("customerContainer");
		    const index = document.querySelectorAll('.customer-block').length;

		    const block = document.createElement("div");
		    block.className = "customer-block";

		    block.innerHTML = `
		        <div class="row">
		            <div class="col-md-6">
		                <label class="form-label">Kh√°ch h√†ng</label>
		                <select class="form-control select2" name="customers[${index}].customerId" style="width: 100%;">
		                    <option></option>
		                    ${customerOptionsHtml}
		                </select>
		            </div>
		            <div class="col-md-6">
		                <label class="form-label">Ng∆∞·ªùi li√™n h·ªá</label>
		                <input type="text" class="form-control contact-person-input" readonly />
		            </div>
		        </div>
		        
		        <div class="col-md-12 mt-2 interaction-group">
		            <label class="form-label">T∆∞∆°ng t√°c g·∫ßn ƒë√¢y</label>
		            <select class="form-control interaction-select2" style="width: 100%;">
		                <option value="">Ch·ªçn t∆∞∆°ng t√°c...</option>
		            </select>
		            <small class="text-muted created-at-label"></small>
		        </div>
	        
		        <button type="button" class="btn btn-link text-danger remove-btn" onclick="removeCustomer(this)">üóëÔ∏è</button>
		    `;

		    container.appendChild(block);

		    const newSelect = block.querySelector('.select2');
		    $(newSelect).select2({
		        placeholder: "Nh·∫≠p ho·∫∑c ch·ªçn t√™n c√¥ng ty",
		        width: "100%",
		        tags: true,
			    allowClear: true,
			    language: "vi",
			    allowClear: true
		    });

		    // C·∫≠p nh·∫≠t tr∆∞·ªùng ng∆∞·ªùi li√™n h·ªá khi ch·ªçn kh√°ch h√†ng
		    $(newSelect).on("change", function () {
		        const contactPerson = $(this).find(":selected").data("contact-person") || "";
		        $(this).closest(".row").find(".contact-person-input").val(contactPerson);
		    });
		}

		
		function removeCustomer(button) {
		    button.closest('.customer-block').remove();
		}
	</script>

</body>
</html>
